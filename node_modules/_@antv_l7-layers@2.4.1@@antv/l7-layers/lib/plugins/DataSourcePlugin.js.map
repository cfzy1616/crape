{"version":3,"sources":["../../src/plugins/DataSourcePlugin.ts"],"names":["DataSourcePlugin","mapService","layer","getContainer","get","TYPES","IMapService","hooks","init","tap","sourceOption","data","options","setSource","Source","updateClusterData","beforeRenderData","neeUpdateCluster","dataSourceNeedUpdate","dataState","source","getSource","cluster","clusterOptions","zoom","maxZoom","newZoom","getZoom","Math","abs","floor"],"mappings":";;;;;;;;;;;;;AAAA;;AAOA;;AACA;;;;IAIqBA,gB,WADpB,4B;;;SAEWC,U;;;;;WACV,eAAaC,KAAb,EAA4B;AAAA;;AAC1B,WAAKD,UAAL,GAAkBC,KAAK,CAACC,YAAN,GAAqBC,GAArB,CAAsCC,cAAMC,WAA5C,CAAlB;AACAJ,MAAAA,KAAK,CAACK,KAAN,CAAYC,IAAZ,CAAiBC,GAAjB,CAAqB,kBAArB,EAAyC,YAAM;AAC7C,kCAA0BP,KAAK,CAACQ,YAAhC;AAAA,YAAQC,IAAR,uBAAQA,IAAR;AAAA,YAAcC,OAAd,uBAAcA,OAAd;AACAV,QAAAA,KAAK,CAACW,SAAN,CAAgB,IAAIC,iBAAJ,CAAWH,IAAX,EAAiBC,OAAjB,CAAhB;;AACA,QAAA,KAAI,CAACG,iBAAL,CAAuBb,KAAvB;AACD,OAJD;AAOAA,MAAAA,KAAK,CAACK,KAAN,CAAYS,gBAAZ,CAA6BP,GAA7B,CAAiC,kBAAjC,EAAqD,YAAM;AACzD,YAAMQ,gBAAgB,GAAG,KAAI,CAACF,iBAAL,CAAuBb,KAAvB,CAAzB;;AACA,YAAMgB,oBAAoB,GAAGhB,KAAK,CAACiB,SAAN,CAAgBD,oBAA7C;AACAhB,QAAAA,KAAK,CAACiB,SAAN,CAAgBD,oBAAhB,GAAuC,KAAvC;AACA,eAAOD,gBAAgB,IAAIC,oBAA3B;AACD,OALD;AAMD;;;WAED,2BAA0BhB,KAA1B,EAAkD;AAChD,UAAMkB,MAAM,GAAGlB,KAAK,CAACmB,SAAN,EAAf;AACA,UAAMC,OAAO,GAAGF,MAAM,CAACE,OAAvB;AACA,kCAAmCF,MAAM,CAACG,cAA1C;AAAA,yDAAQC,IAAR;AAAA,UAAQA,IAAR,uCAAe,CAAf;AAAA,yDAAkBC,OAAlB;AAAA,UAAkBA,OAAlB,uCAA4B,EAA5B;AACA,UAAMC,OAAO,GAAG,KAAKzB,UAAL,CAAgB0B,OAAhB,KAA4B,CAA5C;AACA,UAAMT,oBAAoB,GAAGhB,KAAK,CAACiB,SAAN,CAAgBD,oBAA7C;;AAEA,UACEI,OAAO,KACNJ,oBAAoB,IAAIU,IAAI,CAACC,GAAL,CAASL,IAAI,GAAGE,OAAhB,IAA2B,CAD7C,CAAP,IAEAD,OAAO,GAAGD,IAHZ,EAIE;AACAJ,QAAAA,MAAM,CAACL,iBAAP,CAAyBa,IAAI,CAACE,KAAL,CAAWJ,OAAX,CAAzB;AACA,eAAO,IAAP;AACD;;AACD,aAAO,KAAP;AACD","sourcesContent":["import {\n  ILayer,\n  ILayerPlugin,\n  ILngLat,\n  IMapService,\n  TYPES,\n} from '@antv/l7-core';\nimport Source from '@antv/l7-source';\nimport { injectable } from 'inversify';\nimport { cloneDeep } from 'lodash';\n\n@injectable()\nexport default class DataSourcePlugin implements ILayerPlugin {\n  protected mapService: IMapService;\n  public apply(layer: ILayer) {\n    this.mapService = layer.getContainer().get<IMapService>(TYPES.IMapService);\n    layer.hooks.init.tap('DataSourcePlugin', () => {\n      const { data, options } = layer.sourceOption;\n      layer.setSource(new Source(data, options));\n      this.updateClusterData(layer);\n    });\n\n    // 检测数据是否需要更新\n    layer.hooks.beforeRenderData.tap('DataSourcePlugin', () => {\n      const neeUpdateCluster = this.updateClusterData(layer);\n      const dataSourceNeedUpdate = layer.dataState.dataSourceNeedUpdate;\n      layer.dataState.dataSourceNeedUpdate = false;\n      return neeUpdateCluster || dataSourceNeedUpdate;\n    });\n  }\n\n  private updateClusterData(layer: ILayer): boolean {\n    const source = layer.getSource();\n    const cluster = source.cluster;\n    const { zoom = 0, maxZoom = 16 } = source.clusterOptions;\n    const newZoom = this.mapService.getZoom() - 1;\n    const dataSourceNeedUpdate = layer.dataState.dataSourceNeedUpdate;\n    // 如果 dataSource 有更新，跳过 zoom 的判断，直接更新一次\n    if (\n      cluster &&\n      (dataSourceNeedUpdate || Math.abs(zoom - newZoom) > 1) &&\n      maxZoom > zoom\n    ) {\n      source.updateClusterData(Math.floor(newZoom));\n      return true;\n    }\n    return false;\n  }\n}\n"],"file":"DataSourcePlugin.js"}